<!DOCTYPE html>
<meta charset="utf-8">
<style>
text {
  font: bold 12px monospace;
}

.enter {
  fill: black;
}

.update {
  fill: #333;
}

.dots{
  stroke-width: 0px;
  fill: #000000;
  fill-opacity: 0.8;
}

.title {
  font: bold 20px monospace;
}

</style>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

<script src="College_Freshman"></script>

<script src="templateinfo.js"></script>

<script>

var width = 1000,
    height = 300,
    charge_multiplier = 1,
    beginning = 1293858482,
    timewidth = 92410246,
    vizwidth = width/2,
    horizontalBorder = 100;

/*
Script to convert json data (raw data, timestamp, 
karma, etc) into visualization dependent parameters 
(size, momentum, x,y position)
*/

function process(rawAnimals, toSort){

  function sortByKey(array, key) {
      return array.sort(function(a, b) {
          var x = a[key]; var y = b[key];
          return ((x < y) ? -1 : ((x > y) ? 1 : 0));
      });
  }

  var animals = [];
  for (i = 0; i < rawAnimals.length; i++) {
    animal = rawAnimals[i];
    t = (animal["cr"]-beginning)/timewidth;
    s = 6*Math.max(animal["pt"]/1000,0.02);
    xval = t*(vizwidth*2-2*horizontalBorder)
           -vizwidth+horizontalBorder
    animals.push({"ts":animal["cr"],
                  "ti":animal["ti"],
                  "t":xval,
                  "s":Math.pow(s,0.5)*1.6,
                  "x":xval,
                  "y":(Math.random()-0.5)*150,
                  "id" : animal["id"]}); 

  } 
  sortByKey(animals, "t")
  animals.reverse()
  return animals;
}

animalData = {};

//animalData["3rd World Success Kid"] = process(rawFreshman)
//animalData["Advice Dog"] = process(rawLazy)

var animals = [];

// variable [animals] is captured from the main scope.
function updateList(newdat) {
  
  randinti = (newdat.length-animals.length > 1000);

  for (var i = 0; i < newdat.length; i++) {
    if (i < animals.length) {
      animals[i].t  = newdat[i].t;
      animals[i].ti  = newdat[i].ti;
      animals[i].ts  = newdat[i].ts;      
      animals[i].s  = newdat[i].s;
      animals[i].id = newdat[i].id;
      if (randinti){
        animals[i].x  = newdat[i].t,
        animals[i].y  - (Math.random()-0.5)*150   
        animals[i].px  = newdat[i].t,
        animals[i].py  - (Math.random()-0.5)*150 
      }       
    } else {
      animals[i] = {"ts":newdat[i].ts,
                    "ti":newdat[i].ti,
                    "t" :newdat[i].t,
                    "s" :newdat[i].s,
                    "id":newdat[i].id,
                    "x" :newdat[i].t,
                    "y" :(Math.random()-0.5)*150}
    }
  }
  
  animals.splice(i,animals.length)    

}

/*
Four SVG Element
*/

var title = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", 100)
    .style("margin-left","auto")
    .style("margin-right","auto")
    .style("margin-top","0.1cm")    
    .style("display","block") 


var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height+20)
    .style("margin-left","auto")
    .style("margin-right","auto")
    .style("margin-top","0.5cm")    
    .style("display","block")    
    .append("g")
    .attr("transform", "translate(" + (width/2)  + "," 
                                    + (height/2) + ")");

var thumbBar = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", 40)
    .style("margin-left","auto")
    .style("margin-right","auto")
    .style("margin-top","1cm")        
    .style("display","block");

var thumbText = d3.select("body").append("svg")
    .attr("width", width) // Height to be set later
    .style("margin-left","auto")
    .style("margin-right","auto")
    .style("display","block");
/*
Set Title, and Info Text
*/

var titletext = title.append('text');

titletext.attr('x',500)
    .attr('y',55)
    .attr("fill","black")
    .attr("text-anchor","middle")
    .attr("class", "title")
    .text( function (d) { return "Insanity Wolf"; })

var infotext = title.append('text');

infotext.attr('x',500)
    .attr('y',85)
    .attr("fill","black")
    .attr("text-anchor","middle")
    .text( function (d) { return "Insanity Wolf"; })
  
/*
Set Graph
*/

svg.append('rect')
    .attr('x',-vizwidth).attr('y',-height/2)
    .attr('width',vizwidth*2).attr('height',height)
    .attr('fill','white')
    .attr('stroke','black').attr('stroke-width',2)
    //.attr('stroke-dasharray','8,8') 

dates = d3.time.scale()
        .domain([1293858482*1000,(1293858482+92410246)*1000])
        .range([-vizwidth,vizwidth])
        .nice()

axis = svg.selectAll("axis")

axis.data(dates.ticks(24))
  .enter()
  .append('line')
    .attr('x1',dates)
    .attr('x2',dates)
    .attr('y1',-150)
    .attr('y2',150)
    .attr('stroke-width','0.5')
    .attr('stroke-dasharray','5,5') 
    .attr('stroke','#000000')

axis.data(dates.ticks(8))
  .enter()
  .append("text")
    .attr("x", dates)
    .attr("y", 165)
    .attr("text-anchor", "middle")
    .text(function(d,i) {
      console.log(d)
      if (i != 0 && i != 13){
        return dates.tickFormat(10)(d);
      } else {
        return '';
      }
    });

mut = 1.2;
tcharge = 200*mut;

function returnToTimeline(alpha) {
  return function(d) {
    var x = d.x - d.t;
        y = d.y - 0,
        l = (x*x + y*y),
  l = alpha*mut*1.7*Math.pow(d.s*0.2,0)*1.2// + alpha*Math.abs(y)*0.005;
  d.x -= x *= l*1.5*vforce;
  d.y -= y *= l;
  };

}

var force = d3.layout.force()
	.charge(function(d, i) { 
      return Math.min(-tcharge*Math.pow(d.s/8,2.2),-2) 
    })
  .nodes(animals)
	.size([width,0])
	.gravity(0)

var text = svg.selectAll("dotsdata").data(animals);

Array.prototype.clear = function() {
  while (this.length > 0) {
    this.pop();
  }
};

function update() {

  // Only apply to objects which were just inserted 
  text.enter().append("circle");
  
  text
  	.attr("r",function(d, i) { return 0 })
  	.attr("style","dots")
  	//.call(force.drag)
  	.on("mouseover", function(d){
      var date = new Date(d.ts*1000);
      console.log(date)
  		d3.select(this).style("fill", "red");
      infotext.text( function (dd) { return d.ti; })      
  		})
  	.on("click", function(d){
  			window.open(
          "http://www.reddit.com/r/AdviceAnimals/" 
          + d.id,'_blank');
  		})
    .on("mouseout", function(){
        d3.select(this).style("fill", "black");
      })
    .transition()
      .duration(function(d,i) {return 0.5*(animals.length -i)} )
      .attr("r",function(d,i) { return d.s });

  text.exit().remove();
  force.start();
}

var current = 0;

function update_data(newAnimals) {

  updateList(newAnimals);

  text = text.data(force.nodes(), 
    function(d) {return d.id; });

  text.exit()
    .transition()
      .duration(function(d,i) {return (0.2)*i} )
      .attr("r",function(d, i) { return 0 })
    .remove();  
  // Only apply to objects which were just inserted 

  text.enter().append("circle").attr("r",0)
  // Apply to all objects
  text
    .attr("style","dots")
    .on("mouseover", function(d){
      d3.select(this).style("fill", "red");
      infotext.text( function (dd) { return d.ti; })
      })
    .on("click", function(d){
        window.open(
          "http://www.reddit.com/r/AdviceAnimals/" 
          + d.id,'_blank');
      })
    .on("mouseout", function(){
        d3.select(this).style("fill", "black");
      })
    .transition()
      .duration(function(d,i) {
        return  (10)*Math.sqrt(i)} )
      .attr("r",function(d, i) { return d.s });

  force.start()
}

update()
force.start();
vforce = 2.5

force.on("tick", function(e) {

  s = 0;
  for(var i = 0; i < animals.length; i++){
    var dx = animals[i].x - animals[i].px;
    var dy = animals[i].y - animals[i].py;
    var d = Math.sqrt(dx*dx + dy*dy); 
    s += d;
  }
  s = s/animals.length

	text
	  .each(returnToTimeline(e.alpha))
    .attr("cx", function(d) { return d.x; })
    .attr("cy", function(d) { return d.y; });

});


/*
Set Thumbnail Bar Text
*/

var thumbnailText = thumbText.append('text');

thumbnailText.attr('x',500)
    .attr('y',10)
    .attr("fill","black")
    .attr("text-anchor","middle")


/**
Set Thumbnail Bar. Alignment is a bit arbituary.
**/

// Some template globals
barWidth = 14
numCols  = 40

numTemplates = templateData.length
numRows      = Math.floor(numTemplates/numCols)
numLastCol   = numTemplates%numCols
marginLast   = (numCols - numLastCol)/2   
leftMargin   = (width - (numCols*barWidth))/2

thumbBar.attr("height", (numRows+3)*barWidth)

var bar = thumbBar.selectAll("g")
    .data(templateData)
  .enter().append("g")
    .attr("transform", 
      function(d, i) {
        var row = (i%numCols)
        var col = Math.floor(i/numCols)
        if (col != numRows) {
          return "translate(" + (row*barWidth + leftMargin) + "," 
                              + col*(barWidth + 2) 
                              + ")";
        }
        else {
          return "translate(" + ((row + marginLast)*barWidth + leftMargin) + "," 
                              + col*(barWidth + 2) 
                              + ")"; }       
      });

logme = ""

function changeMeme(d) {
  // Do Ajax Query

  titletext.text(d.name) 
  // If cached, no need to do query.
  if (d.name in animalData){
    update_data(animalData[d.name])
    return;
  }

  // Otherwise do query
  xhr = new XMLHttpRequest();
  xhr.onload = function() {
    logme = xhr.responseText;
    rawData = JSON.parse(logme)
    animalData[d.name] = process(rawData)
    update_data(animalData[d.name])
  };
  console.log(d.filename)
  xhr.open("GET","memes/" + d.filename); //assuming kgr.bss is plaintext
  xhr.send();
  // Otherwise, do query

}

function mouseOverThumb(d) {
  thumbnailText.text(d.name)
  // get rectangle, even if mouse is over circle  
  rect = this.parentNode.childNodes[0] 
  d3.select(rect).style("fill", "red")
}

function mouseOutThumb(d) {
  thumbnailText.text("")
  rect = this.parentNode.childNodes[0] 
  circ = this.parentNode.childNodes[1]

  d3.select(rect).style("fill", "black")
  d3.select(circ).style("fill", "white")

}

square = bar.append("g")

square.append("rect")
    .attr("height",  barWidth - 2)
    .attr("width", barWidth - 2)
    .attr("id", "square")    
    .on("click", changeMeme)
    .on("mouseover", mouseOverThumb)    
    .on("mouseout", mouseOutThumb);

square.append("circle")
    .attr("style", "fill:white")
    .attr("r",  10)
    .attr("cx", (barWidth - 2)/2)
    .attr("cy", (barWidth - 2)/2)
    .on("click", changeMeme)    
    .on("mouseover", mouseOverThumb)    
    .on("mouseout", mouseOutThumb)    
    .transition()
      .duration(500)
      .attr("r",function(d) { return Math.log(d.karma)/2 })    



// /**
// Set Slider
// **/

// var sliderx = width/4,
//     slidery = 20;

// var x = d3.scale.linear()
//     .domain([1, 3])
//     .range([0, vizwidth])
//     .clamp(true);

// var brush = d3.svg.brush()
//     .x(x)
//     .extent([0, 0])
//     .on("brush", brushed);

// slidersvg.append("g")
//     .attr("class", "axis")
//     .attr("transform", "translate("+sliderx+","+slidery+")")
//     .call(d3.svg.axis()
//       .scale(x)
//       .tickSize(0)
//       .tickPadding(12))

// var slider = slidersvg.append("g")
//     .call(brush);

// var handle = slider.append("circle")
//     .attr("r", 5)
//     .attr("fill","black")
//     .attr("transform", "translate("+sliderx+","+slidery+")");;

// function brushed() {
	
//   var value = x.invert(d3.mouse(this)[0]-sliderx);
//   brush.extent([value, value]);
//   handle.attr("cx", x(value));

//   for (var i = 0; i < animals.length; i++) {
//   }

//   vforce = value;
//   force.start()
// }

</script>