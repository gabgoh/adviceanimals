__author__ = 'Gabriel'
from skimage import data
from numpy import *
import pickle
from matplotlib.pyplot import *
import os

"""
Viusalize the sorted thumbnails, tools to set cutoff by hand, and
finally generate a JSON File.
"""

"""
This section populates clickedList using a GUI
"""

clickedList = []

def previewThumbs(thumbList, dims):

    thumbdir = 'D:\\memeproject\\thumbnails\\'
    pview = uint8(np.zeros((70*dims[0],70*dims[1],3)));
    for i in range(0,dims[0]*dims[1]):
        thumb = data.load(thumbdir + thumbList[i])[:,:,0:3]
        if thumb.shape[1] != 70:
            blankRight = uint8(zeros((thumb.shape[0], 70 - shape(thumb)[1],3)))
            thumb = concatenate((thumb, blankRight),axis=1)
        blankBottom = uint8(zeros((70 - shape(thumb)[0],70,3)))
        pthumb = concatenate((thumb, blankBottom))
        x = i/dims[1]
        y = i - dims[1]*(i/dims[1])
        pview[70*x:70*(x+1), 70*y:70*(y+1)] = pthumb

    pviewOriginal = copy(pview)
    # Generate Plot and assign callback on click
    thumbPlot = figure()
    ax = thumbPlot.add_subplot(111)
    imageWindow = ax.imshow(pview)

    def coord2ij(coord):
        # Coordinate to (i,j) position on screen
        return (coord/dims[1], coord%dims[1])

    def highlight(coord):
        ij = coord2ij(coord)
        x = (ij[0]*70,(ij[0]+1)*70)
        y = (ij[1]*70,(ij[1]+1)*70)

        pview[ x[0]:x[1] , y[0]:y[1] ] = pview[ x[0]:x[1] , y[0]:y[1] ] + 10
        return pview

    def setborder(coord):
        ij = coord2ij(coord)
        x = (ij[0]*70,(ij[0]+1)*70)
        y = (ij[1]*70,(ij[1]+1)*70)

        pview[ x[0]:x[1] , y[0]:y[1] ] = 0
        pview[ (x[0] + 3):(x[1] - 3) , (y[0] + 3):(y[1] - 3) ] = 255

        pview[ (x[0] + 6):(x[1] - 6) , (y[0] + 6):(y[1] - 6) ] = pviewOriginal[ (x[0] + 6):(x[1] - 6) , (y[0] + 6):(y[1] - 6) ]

        return pview

    def unhighlight(coord):
        ij = coord2ij(coord)

        x = (ij[0]*70,(ij[0]+1)*70)
        y = (ij[1]*70,(ij[1]+1)*70)

        pview[ x[0]:x[1] , y[0]:y[1] ] = pviewOriginal[ x[0]:x[1] , y[0]:y[1] ]
        return pview

    def onclick(event):
        ij = (math.floor(event.ydata/70), math.floor(event.xdata/70))
        coord = int((ij[0] * dims[1]) + ij[1])

        if event.button == 2:
            # Left Click
            if coord in clickedList:
                unhighlight(coord)
                clickedList.remove(coord)
            else:
                setborder(coord)
                clickedList.append(coord)

        if event.button == 3:
            # Right Click to choose cutoff
            del clickedList[:]
            pview[:] = pviewOriginal[:]

            for i in range(0,coord+1):
                clickedList.append(i)
                setborder(i)

        clickedList.sort()
        print clickedList

        imageWindow.set_data(pview)
        thumbPlot.canvas.draw()
        print coord
        print 'button=%d, x=%d, y=%d, xdata=%f, ydata=%f'%(
            event.button, event.x, event.y, event.xdata, event.ydata)

    thumbPlot.canvas.mpl_connect('button_press_event', onclick)

# Load all summaries

fp = open(r'D:\memeproject\thumbsnailSummaryTitles','r')
allThumbs = pickle.load(fp)
fp.close()

print "Summaries Loaded"

templateList = os.listdir(r'D:\memeproject\templates')
templateList = ["10_Guy.jpg"]
for currentMemeTemplateName in templateList:

    """
    Read and visualize the sorted thumbnails generated by sortThumbs.py
    """

    # Open the pre-cached meme distance data
    fp = open('D:\\memeproject\\thumbssort\\' + currentMemeTemplateName,'r')
    (s, cutoff) = pickle.load(fp)
    fp.close()

    thumbList = [i[1] for i in s]
    previewThumbs(thumbList, (40,100))
    show()


    """
    Turn ClickedList into a JSON File, ready for use in the browser.
    """

    from operator import itemgetter
    import json

    allMemesCuratedData = []
    sMemes = itemgetter(*clickedList)(s)
    for meme in sMemes:
        m = allThumbs[meme[1]]
        memeCurated = { 'id' : meme[1][0:-4],
                        'cr': m['created'],
                        'pt': m['ups'] - m['downs'],
                        'ti': m['title'] }
        allMemesCuratedData.append(memeCurated)

    print allMemesCuratedData
    fp = open('D:\\memeproject\\code\html\\' + currentMemeTemplateName[0:-4] + ".js", 'w')
    json.dump(allMemesCuratedData, fp)
    fp.close()